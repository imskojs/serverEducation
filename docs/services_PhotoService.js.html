<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>services/PhotoService.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#apn">apn</a></li><li><a href="global.html#find">find</a></li><li><a href="global.html#jwt">jwt</a></li><li><a href="global.html#Promise">Promise</a></li><li><a href="global.html#validator">validator</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">services/PhotoService.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Created by andy on 26/05/15
 * As part of IonicWorkshop
 *
 * Copyright (C) Applicat (www.applicat.co.kr) &amp; Andy Yoon Yong Shin - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Andy Yoon Yong Shin &lt;andy.shin@applicat.co.kr>, 26/05/15
 *
 */


var Promise = require('bluebird');
var cloudinary = require('cloudinary');
var fs = require('fs');

var appTags = [];

module.exports = {
  init: init,
  getService: getService,

  upload: upload,
  uploadForUpdate: uploadForUpdate,
  remove: remove
};

function init() {
  cloudinary.config(sails.config.connections.cloudinary);
  appTags = sails.config.connections.cloudinary.tags;
}

function getService() {
  return cloudinary;
}


function upload(req) {

  var allUpstreams = new Promise(function (resolve, reject) {
    req.file('file').upload(function (err, uploads) {
      if (err)
        return reject(err);
      return resolve(uploads)
    })
  });

  return Promise.resolve(allUpstreams)
    .bind({})
    .then(function (imageInServer) {
      this.imageInServer = imageInServer[0];
      return cloudinary.uploader.upload(this.imageInServer.fd, null, {tags: appTags})
    })
    .then(function (imageInCloudinary) {
      fs.unlink(this.imageInServer.fd);

      _.each(req.body, function (value, key) {
        if (key.indexOf('.' > -1)) {
          var newKey = key.split('.')[0];
          req.body[newKey] = [value];
          delete req.body[key];
        }
      });
      var imageToSave = _.extend(imageInCloudinary, req.body);
      return Photo.create(imageToSave);
    });
}

function uploadForUpdate(req) {

  var allUpstreams = new Promise(function (resolve, reject) {
    req.file('file').upload(function (err, uploads) {
      if (err)
        return reject(err);
      return resolve(uploads)
    })
  });

  return Promise.resolve(allUpstreams)
    .bind({})
    .then(function (imageInServer) {
      this.imageInServer = imageInServer[0];
      return cloudinary.uploader.upload(this.imageInServer.fd, null, {tags: appTags})
    })
    .then(function (imageInCloudinary) {
      fs.unlink(this.imageInServer.fd);

      _.each(req.body, function (value, key) {
        if (key.indexOf('.' > -1)) {
          var newKey = key.split('.')[0];
          req.body[newKey] = [value];
          delete req.body[key];
        }

      });
      var imageToSave = _.extend(imageInCloudinary, req.body);
      return imageToSave;
    });
}


// TODO: need to check thi function
function remove(id, callback) {
// Find photo metadata first
  Photo.findOne({id: id})
    .then(function (photo) {

      sails.log.debug("removing photo:" + photo.id);

      // If exist delete from cloud
      return cloudinary.uploader.destroy(photo.public_id, null);
    })
    .then(function (photo) {

      sails.log.debug('after: ' + JSON.stringify(photo));
      // On success delete metadata from out db
      return Photo.destroy({id: id});
    })
    .then(function (photos) {
      if (callback)
        return callback(null, photos);
    })
    .catch(function (err) {
      if (callback)
        return callback(err);
    });
}


/**********************************
 *
 *         Private Method
 *
 **********************************/

</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Apr 07 2016 14:13:01 GMT+0900 (KST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
